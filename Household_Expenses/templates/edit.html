<!DOCTYPE html>
<html lang="ja" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>レシート編集</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div class="container">
    <header class="d-flex flex-wrap border-bottom">
      <ul class="nav me-auto">
        <li><span class="fs-4 nav-link px-2 text-white">レシート編集</span></li>
      </ul>
      <ul class="nav">
        <li><a href="{{ root_path }}/" class="fs-4 nav-link px-2 text-secondary">一覧</a></li>
        <li><a href="{{ root_path }}/summary" class="fs-4 nav-link px-2 text-secondary">集計</a></li>
      </ul>
    </header>
    {% if error %}
      <div class="alert alert-danger">{{ error }}</div>
    {% endif %}
    <div class="row">
  <div class="col-lg-7 col-md-12 order-2 order-lg-1">
        <form method="post" action="{{ root_path }}/edit/{{ invoice['id'] }}">
          <label class="form-label">店名</label>
          <div class="mb-3 input-group">
            <input id="shop-name" type="text" class="form-control" name="店名" value="{{ invoice['店名'] }}">
            <button type="button" class="btn btn-sm btn-warning" onclick="askAI('shop-name');">AI</button>
          </div>
          <label class="form-label">店舗名</label>
          <div class="mb-3 input-group">
            <input id="vendor-recipient" type="text" class="form-control" name="店の受取人" value="{{ invoice['店の受取人'] }}">
            <button type="button" class="btn btn-sm btn-warning" onclick="askAI('vendor-recipient');">AI</button>
          </div>
          <div class="mb-3">
            <label class="form-label">店の住所</label>
            <input type="text" class="form-control" name="店の住所" value="{{ invoice['店の住所'] }}">
          </div>
          <div class="mb-3">
            <label class="form-label">請求日</label>
            <input type="date" class="form-control" name="請求日" value="{{ invoice['請求日'] }}">
          </div>
          <div class="mb-3">
            <label class="form-label">請求書番号</label>
            <input type="text" class="form-control" name="請求書番号" value="{{ invoice['請求書番号'] }}">
          </div>
          <label class="form-label">小計</label>
          <div class="mb-3 input-group">
            <input id="subtotal" type="number" class="form-control " name="小計" value="{{ invoice['小計'] }}">
            <button type="button" class="btn btn-sm btn-secondary" onclick="sameValue('total', 'subtotal')">合計</button>
            <button type="button" class="btn btn-sm btn-warning" onclick="askAI('subtotal');">AI</button>
          </div>
          <label class="form-label">税金</label>
          <div class="mb-3 input-group">
            <input id="tax" type="number" class="form-control" name="税金" value="{{ invoice['税金'] }}">
            <button type="button" class="btn btn-sm btn-warning" onclick="askAI('tax');">AI</button>
          </div>
          <label class="form-label">合計</label>
          <div class="mb-3 input-group">
            <input id="total" type="number" class="form-control" name="合計" value="{{ invoice['合計'] }}">
            <button type="button" class="btn btn-sm btn-secondary" onclick="sameValue('subtotal', 'total')">小計</button>
            <button type="button" class="btn btn-sm btn-warning" onclick="askAI('total');">AI</button>
          </div>
          <hr>
          <h2>品目一覧</h2>
          <table class="table table-striped">
            <thead>
              <tr>
                <th>品名</th>
                <th>金額</th>
                <th>単位</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="items-table-body">
              {% for item in items %}
              <tr>
                <td><input type="text" name="item_{{ item['id'] }}_品名" value="{{ item['品名'] }}" class="form-control"></td>
                <td><input type="number" name="item_{{ item['id'] }}_金額" value="{{ item['金額'] }}" class="form-control item-amount"></td>
                <td><input type="text" name="item_{{ item['id'] }}_単位" value="{{ item['単位'] }}" class="form-control"></td>
                <td><a href="{{ root_path }}/delete_item/{{ item['id'] }}?invoice_id={{ invoice['id'] }}" class="btn btn-sm btn-danger" onclick="return confirm('本当に削除しますか？');">削除</a></td>
              </tr>
              {% endfor %}
              <!-- 新規追加行 -->
              <tr>
                <td><input type="text" name="new_品名" class="form-control" placeholder="新規品名"></td>
                <td><input type="number" name="new_金額" class="form-control item-amount" placeholder="金額"></td>
                <td><input type="text" name="new_単位" class="form-control" value="JPY"></td>
                <td></td>
              </tr>
            </tbody>
          </table>
          <div class="mb-3">
            <label class="form-label">品目の合計金額</label>
            <input type="number" class="form-control" name="品目の合計金額" id="items-total" value="{{ items_total }}" readonly>
          </div>
          <button type="submit" class="btn btn-primary">保存</button>
          <a href="{{ root_path }}/delete/{{ invoice['id'] }}" class="btn btn-danger ms-2" onclick="return confirm('本当に削除しますか？');">レシート削除</a>
          <a href="{{ root_path }}/" class="btn btn-secondary ms-2">戻る</a>
        </form>
      </div>
      <!-- 画像表示: スマホでは上部、PCでは右側 -->
      {% if invoice['画像名'] %}
        <div class="col-12 d-block d-lg-none mb-3 text-center order-1 order-lg-2">
          <img id="receiptImage" src="{{ root_path }}/images/{{ invoice['画像名'] }}" alt="画像" style="max-width:100%; max-height:400px; border-radius:12px; box-shadow:0 0 16px #222; margin-top:16px;">
        </div>
        <div class="col-lg-5 d-none d-lg-block align-self-start order-2 order-lg-2">
          <div class="mb-3 text-end">
            <img id="receiptImage" src="{{ root_path }}/images/{{ invoice['画像名'] }}" alt="画像" style="max-width:100%; max-height:1200px; border-radius:12px; box-shadow:0 0 16px #222; margin-top:16px;">
          </div>
        </div>
      {% endif %}
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // 品目の金額合計を自動計算
    function calculateTotal() {
      var total = 0;
      var itemAmounts = document.querySelectorAll('.item-amount');
      itemAmounts.forEach(function(input) {
        var value = parseFloat(input.value) || 0;
        total += value;
      });
      document.getElementById('items-total').value = total;
    }
    
    // ページ読み込み時に計算
    document.addEventListener('DOMContentLoaded', function() {
      calculateTotal();
      
      // 品目金額の入力フィールドに変更イベントを追加
      var itemAmounts = document.querySelectorAll('.item-amount');
      itemAmounts.forEach(function(input) {
        input.addEventListener('input', calculateTotal);
      });
    });

    function sameValue(sourceId, targetId) {
      var sourceInput = document.getElementById(sourceId);
      var targetInput = document.getElementById(targetId);
      if (sourceInput && targetInput) {
        targetInput.value = sourceInput.value;
      }
    }

    function askAI(targetId) {
      var targetInput = document.getElementById(targetId);
      var receiptImage = document.getElementById('receiptImage');

      if (!targetInput) {
        alert('対象の入力フィールドが見つかりません。');
        return;
      }

      if (!receiptImage) {
        alert('画像がありません。');
        return;
      }

      var imageUrl = receiptImage.src;
      // 画像のフルURLではなく画像名だけをサーバーに送る
      var imageName = (new URL(imageUrl, window.location.href)).pathname.split('/').pop();

      var url = '{{ root_path }}/ask/' + targetId + '?image_name=' + encodeURIComponent(imageName);
      fetch(url)
      .then(response => response.json())
      .then(data => {
        // サーバーは {"answer": "..."} を返す想定
        if (data.answer !== undefined) {
          targetInput.value = data.answer;
        } else {
          alert('AIから値を取得できませんでした。コンソールを確認してください。');
          console.error('Unexpected askAI response:', data);
        }
      })
      .catch(error => {
        alert('AIとの通信中にエラーが発生しました。');
        console.error('Error:', error);
      });
    }
  </script>
</body>
</html>
